# 登录演示系统详细设计文档

## 1. 系统概述

本系统是一个基于Spring Boot和React的登录演示系统，实现了用户认证、权限管理、菜单管理等核心功能。系统采用前后端分离架构，支持JWT令牌认证、用户角色权限控制、菜单树动态生成等特性。

## 2. 技术栈

### 2.1 后端技术栈

| 技术/框架 | 版本 | 用途 |
|---------|------|------|
| Spring Boot | 2.x | 应用程序框架 |
| MyBatis-Plus | 3.x | ORM框架 |
| MySQL | 8.x | 关系型数据库 |
| Redis | 6.x | 缓存、Session存储、分布式锁 |
| JWT | - | 无状态认证 |
| Swagger | 2.9.2 | API文档 |
| Lombok | 1.18.16 | 减少样板代码 |

### 2.2 前端技术栈

| 技术/框架 | 版本 | 用途 |
|---------|------|------|
| React | 17.0.2 | UI库 |
| Ant Design | 4.16.13 | UI组件库 |
| React Router | - | 前端路由 |
| Axios | 0.24.0 | HTTP客户端 |

## 3. 数据库设计

### 3.1 数据库表结构

#### 3.1.1 `users`表 - 用户信息表

```sql
CREATE TABLE `users` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `password` varchar(255) NOT NULL COMMENT '密码',
  `email` varchar(100) NOT NULL COMMENT '邮箱',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `nickname` varchar(50) DEFAULT NULL COMMENT '昵称',
  `avatar` varchar(255) DEFAULT NULL COMMENT '头像',
  `status` tinyint DEFAULT '1' COMMENT '状态 0:禁用 1:启用',
  `locked` tinyint DEFAULT '0' COMMENT '是否锁定 0:未锁定 1:锁定',
  `login_count` int DEFAULT '0' COMMENT '登录次数',
  `last_login_time` datetime DEFAULT NULL COMMENT '最后登录时间',
  `last_login_ip` varchar(50) DEFAULT NULL COMMENT '最后登录IP',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_username` (`username`),
  UNIQUE KEY `idx_email` (`email`),
  UNIQUE KEY `idx_phone` (`phone`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
```

#### 3.1.2 `roles`表 - 角色信息表

```sql
CREATE TABLE `roles` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL COMMENT '角色名称',
  `code` varchar(50) NOT NULL COMMENT '角色编码',
  `description` varchar(255) DEFAULT NULL COMMENT '角色描述',
  `status` tinyint DEFAULT '1' COMMENT '状态 0:禁用 1:启用',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_role_code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
```

#### 3.1.3 `user_roles`表 - 用户角色关联表

```sql
CREATE TABLE `user_roles` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `role_id` bigint NOT NULL COMMENT '角色ID',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_role_id` (`role_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
```

#### 3.1.4 `menus`表 - 菜单信息表

```sql
CREATE TABLE `menus` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `parent_id` bigint DEFAULT '0' COMMENT '父菜单ID',
  `name` varchar(100) NOT NULL COMMENT '菜单名称',
  `path` varchar(255) DEFAULT NULL COMMENT '菜单路径',
  `component` varchar(255) DEFAULT NULL COMMENT '组件路径',
  `key` varchar(100) NOT NULL COMMENT '菜单唯一标识',
  `type` tinyint NOT NULL COMMENT '菜单类型 0:目录 1:菜单 2:按钮',
  `icon` varchar(50) DEFAULT NULL COMMENT '菜单图标',
  `sort_order` int DEFAULT '0' COMMENT '排序号',
  `hidden` tinyint DEFAULT '0' COMMENT '是否隐藏 0:显示 1:隐藏',
  `status` tinyint DEFAULT '1' COMMENT '状态 0:禁用 1:启用',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_parent_id` (`parent_id`),
  KEY `idx_sort_order` (`sort_order`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
```

#### 3.1.5 `role_menus`表 - 角色菜单关联表

```sql
CREATE TABLE `role_menus` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `role_id` bigint NOT NULL COMMENT '角色ID',
  `menu_id` bigint NOT NULL COMMENT '菜单ID',
  PRIMARY KEY (`id`),
  KEY `idx_role_id` (`role_id`),
  KEY `idx_menu_id` (`menu_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
```

#### 3.1.6 `mock_data`表 - Mock挡板数据表

```sql
CREATE TABLE `mock_data` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `data_type` varchar(50) NOT NULL COMMENT '数据类型：sms_code-短信验证码, email_code-邮箱验证码, wechat_qrcode-微信二维码',
  `data_key` varchar(255) NOT NULL COMMENT '数据键：手机号、邮箱或ticket',
  `data_value` varchar(500) COMMENT '数据值：验证码或二维码URL',
  `extra_data` text COMMENT '额外数据：JSON格式存储额外信息',
  `status` varchar(20) DEFAULT 'active' COMMENT '状态：active-有效, expired-过期, used-已使用',
  `expire_time` datetime COMMENT '过期时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  INDEX `idx_data_type_key` (`data_type`, `data_key`),
  INDEX `idx_status` (`status`),
  INDEX `idx_expire_time` (`expire_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Mock挡板数据表';
```

**用途说明**：
- 存储短信验证码：`data_type='sms_code'`，`data_key`为手机号，`data_value`为6位验证码，有效期5分钟
- 存储邮箱验证码：`data_type='email_code'`，`data_key`为邮箱，`data_value`为6位验证码，有效期5分钟
- 存储微信登录二维码：`data_type='wechat_qrcode'`，`data_key`为ticket，`data_value`为二维码URL，`extra_data`存储状态信息，有效期2分钟

#### 3.1.7 `audit_logs`表 - 审计日志表

```sql
CREATE TABLE IF NOT EXISTS `audit_logs` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `user_id` BIGINT(20) DEFAULT NULL COMMENT '用户ID',
  `username` VARCHAR(50) DEFAULT NULL COMMENT '用户名',
  `operation_type` VARCHAR(50) NOT NULL COMMENT '操作类型：LOGIN, LOGOUT, REGISTER, PASSWORD_CHANGE, PASSWORD_RESET, USER_UPDATE, USER_DELETE, ROLE_ASSIGN等',
  `operation_desc` VARCHAR(255) DEFAULT NULL COMMENT '操作描述',
  `ip_address` VARCHAR(50) DEFAULT NULL COMMENT 'IP地址',
  `user_agent` VARCHAR(500) DEFAULT NULL COMMENT '用户代理（User-Agent）',
  `status` VARCHAR(20) NOT NULL COMMENT '操作状态：SUCCESS, FAILURE',
  `error_message` VARCHAR(500) DEFAULT NULL COMMENT '错误信息（如果操作失败）',
  `request_method` VARCHAR(10) DEFAULT NULL COMMENT '请求方法：GET, POST, PUT, DELETE等',
  `request_path` VARCHAR(255) DEFAULT NULL COMMENT '请求路径',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_username` (`username`),
  KEY `idx_operation_type` (`operation_type`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='审计日志表';
```

**用途说明**：
- 记录系统关键操作日志，包括用户登录、登出、注册、密码修改、密码重置等操作
- 存储操作相关的上下文信息：用户信息、IP地址、User-Agent、请求方法和路径
- 区分操作成功和失败状态，失败时记录错误信息
- 支持按用户、操作类型、状态、时间范围等条件查询和统计分析

## 4. 系统架构

### 4.1 整体架构

- **前端**: React + Ant Design + React Router
- **后端**: Spring Boot + MyBatis-Plus
- **数据层**: MySQL + Redis
- **认证**: JWT Token

### 4.2 核心流程图

#### 4.2.1 登录流程

```mermaid
sequenceDiagram
    participant Client as 前端
    participant Server as 后端API
    participant DB as 数据库
    participant Redis as Redis缓存

    Client->>Server: POST /auth/login (username, password)
    Server->>Redis: 检查用户是否锁定
    alt 用户已锁定
        Redis-->>Server: 返回锁定信息
        Server-->>Client: 403 用户已锁定
    else 用户未锁定
        Server->>DB: 查询用户信息
        alt 用户不存在或密码错误
            DB-->>Server: 返回空或验证失败
            Server->>Redis: 记录登录失败次数
            Server-->>Client: 401 用户名或密码错误
        else 验证成功
            DB-->>Server: 返回用户信息
            Server->>Server: 生成JWT Token
            Server->>Redis: 重置登录失败次数
            Server-->>Client: 200 OK {accessToken, refreshToken}
        end
    end
```

#### 4.2.2 手机验证码登录流程

```mermaid
sequenceDiagram
    participant Client as 前端
    participant AuthController as 认证控制器
    participant UserService as 用户服务
    participant MockDataMapper as Mock数据Mapper
    participant DB as 数据库

    Client->>AuthController: POST /auth/send-sms-code {phone}
    AuthController->>UserService: sendSmsCode(phone)
    UserService->>DB: 检查用户是否存在
    DB-->>UserService: 返回用户信息
    UserService->>UserService: 检查发送频率限制
    UserService->>UserService: 生成6位随机验证码
    UserService->>MockDataMapper: 保存验证码到mock_data表
    MockDataMapper->>DB: INSERT验证码数据
    DB-->>MockDataMapper: 保存成功
    MockDataMapper-->>UserService: 操作完成
    UserService-->>AuthController: 发送成功
    AuthController-->>Client: 200 OK

    Note over Client: 用户输入验证码
    Client->>AuthController: POST /auth/login-by-phone {phone, code}
    AuthController->>UserService: loginByPhone(phone, code)
    UserService->>MockDataMapper: 查询验证码
    MockDataMapper->>DB: SELECT验证码数据
    DB-->>MockDataMapper: 返回验证码
    MockDataMapper-->>UserService: 返回验证码信息
    UserService->>UserService: 验证码校验
    alt 验证码正确且有效
        UserService->>MockDataMapper: 标记验证码已使用
        UserService->>DB: 查询用户信息
        DB-->>UserService: 返回用户信息
        UserService->>UserService: 生成JWT Token
        UserService-->>AuthController: 返回认证响应
        AuthController-->>Client: 200 OK {accessToken, refreshToken}
    else 验证码错误或过期
        UserService-->>AuthController: 抛出异常
        AuthController-->>Client: 400 验证码错误或已过期
    end
```

#### 4.2.3 微信扫码登录流程

```mermaid
sequenceDiagram
    participant Client as 前端
    participant AuthController as 认证控制器
    participant UserService as 用户服务
    participant MockDataMapper as Mock数据Mapper
    participant DB as 数据库

    Client->>AuthController: GET /auth/wechat/qrcode
    AuthController->>UserService: getWechatQrcode()
    UserService->>UserService: 生成唯一ticket和二维码URL
    UserService->>MockDataMapper: 保存二维码数据
    MockDataMapper->>DB: INSERT二维码数据
    DB-->>MockDataMapper: 保存成功
    MockDataMapper-->>UserService: 操作完成
    UserService-->>AuthController: 返回二维码响应
    AuthController-->>Client: 200 OK {qrcodeUrl, ticket}

    Note over Client: 前端轮询查询扫码状态
    loop 每秒轮询（最多2分钟）
        Client->>AuthController: GET /auth/wechat/status?ticket=xxx
        AuthController->>UserService: getWechatStatus(ticket)
        UserService->>MockDataMapper: 查询二维码数据
        MockDataMapper->>DB: SELECT二维码数据
        DB-->>MockDataMapper: 返回二维码信息
        MockDataMapper-->>UserService: 返回二维码信息
        UserService->>UserService: 解析状态信息
        alt 状态为waiting
            UserService->>UserService: 模拟扫码流程（15秒后scanned，30秒后confirmed）
        end
        alt 状态为confirmed
            UserService->>DB: 查询或创建用户
            DB-->>UserService: 返回用户信息
            UserService->>UserService: 生成JWT Token
            UserService-->>AuthController: 返回状态和认证响应
            AuthController-->>Client: 200 OK {status: confirmed, authResponse}
            Note over Client: 登录成功，停止轮询
        else 状态为waiting/scanned
            UserService-->>AuthController: 返回当前状态
            AuthController-->>Client: 200 OK {status: waiting/scanned}
        else 状态为expired
            UserService-->>AuthController: 返回过期状态
            AuthController-->>Client: 200 OK {status: expired}
            Note over Client: 二维码已过期，停止轮询
        end
    end
```

#### 4.2.4 菜单获取流程

```mermaid
sequenceDiagram
    participant Client as 前端
    participant AuthController as 认证控制器
    participant UserService as 用户服务
    participant MenuService as 菜单服务
    participant DB as 数据库

    Client->>AuthController: GET /auth/user-menu (带Token)
    AuthController->>AuthController: 解析Token获取用户名
    AuthController->>UserService: 获取用户角色列表
    UserService->>DB: 查询用户角色
    DB-->>UserService: 返回角色列表
    UserService->>MenuService: 获取角色菜单树
    MenuService->>DB: 查询菜单信息
    DB-->>MenuService: 返回菜单列表
    MenuService->>MenuService: 构建菜单树结构
    MenuService-->>UserService: 返回菜单树
    UserService-->>AuthController: 返回菜单树
    AuthController-->>Client: 200 OK {menus: [...]}
```

## 5. 后端功能设计

### 5.1 核心模块

#### 5.1.1 认证模块 (AuthController)

**主要功能**：处理用户认证相关请求，包括注册、登录、获取用户菜单、登出和刷新Token。

**关键接口**：
- `POST /auth/register` - 用户注册
- `POST /auth/login` - 用户登录（账号密码）
- `POST /auth/send-sms-code` - 发送手机验证码
- `POST /auth/login-by-phone` - 手机验证码登录
- `POST /auth/send-email-code` - 发送邮箱验证码（用于密码找回）
- `POST /auth/reset-password` - 重置密码（支持邮箱和手机号两种方式）
- `GET /auth/wechat/qrcode` - 获取微信登录二维码
- `GET /auth/wechat/status` - 查询微信扫码状态
- `GET /auth/user-menu` - 获取当前用户菜单
- `POST /auth/logout` - 用户登出
- `POST /auth/refresh` - 刷新访问令牌
- `GET /auth/validate` - 验证Token有效性

#### 5.1.2 用户模块 (UserController, UserServiceImpl)

**主要功能**：用户信息管理、用户认证逻辑实现。

**核心方法**：
- `register(RegisterRequest)` - 用户注册逻辑
- `login(LoginRequest)` - 用户登录逻辑，包含密码验证、Token生成、登录失败限制
- `sendSmsCode(String)` - 发送手机验证码，生成6位随机验证码并保存到mock_data表，有效期5分钟，1分钟内防重复发送
- `loginByPhone(String, String)` - 手机验证码登录，验证验证码有效性和正确性，成功后生成Token
- `getWechatQrcode()` - 获取微信登录二维码，生成唯一ticket和二维码URL，保存到mock_data表
- `getWechatStatus(String)` - 查询微信扫码状态，轮询检查扫码和确认状态，支持模拟扫码流程
- `logout(String)` - 用户登出，将Token加入黑名单
- `getUserMenus(String)` - 获取用户可访问的菜单列表
- `checkUserLocked(String)` - 检查用户是否锁定
- `updatePassword(Long, String)` - 更新用户密码，包含密码加密和数据库更新
- `sendEmailCode(String)` - 发送邮箱验证码（用于密码找回），生成6位随机验证码并保存到mock_data表，有效期5分钟，1分钟内防重复发送
- `resetPassword(String, String, String, String)` - 通过邮箱或手机号重置密码，验证验证码有效性和正确性，成功后更新密码

**关键接口**：
- `PUT /users/{id}/password` - 更新用户密码，接收新密码参数，返回操作结果
- `POST /auth/send-email-code` - 发送邮箱验证码，需要邮箱参数
- `POST /auth/reset-password` - 重置密码，支持邮箱和手机号两种方式，需要账号、验证码和新密码参数

#### 5.1.3 菜单模块 (MenuController, MenuServiceImpl)

**主要功能**：菜单管理、菜单树构建。

**核心方法**：
- `listAllMenus()` - 获取所有菜单
- `listMenusByRoleIds(List<Long>)` - 根据角色ID列表获取菜单
- `getUserMenuTree(List<Long>)` - 获取用户菜单树
- `buildMenuTree(List<Menu>)` - 构建菜单树结构
- `addChildMenus(Menu, Map<Long, List<Menu>>)` - 递归添加子菜单

#### 5.1.4 验证码模块 (CaptchaController, CaptchaService)

**主要功能**：图形验证码生成、验证和管理。

**核心方法**：
- `generateCaptchaImage()` - 生成图形验证码图片（Base64格式）
- `generateCaptchaText()` - 生成验证码文本
- `validateCaptcha(String, String)` - 验证验证码正确性
- `requiresCaptcha(String)` - 判断是否需要验证码（基于登录失败次数）

**关键接口**：
- `GET /captcha/image` - 获取验证码图片，返回Base64编码的图片和验证码key
- `GET /captcha/required?username=xxx` - 检查指定用户名是否需要验证码

**安全机制**：
- 验证码存储在Redis中，有效期5分钟
- 验证码验证后立即删除，防止重复使用
- 登录失败次数达到阈值（默认2次）后要求输入验证码

#### 5.1.5 审计日志模块 (AuditLogController, AuditLogService)

**主要功能**：记录和查询系统关键操作的审计日志。

**核心方法**：
- `log(String, String, Long, String, String, String, String, String, String, String)` - 记录审计日志（通用方法）
- `logSuccess(String, String, Long, String, String, String, String, String)` - 记录成功操作
- `logFailure(String, String, Long, String, String, String, String, String, String)` - 记录失败操作
- `getAuditLogs(...)` - 查询审计日志（支持多条件筛选和分页）
- `countAuditLogs(...)` - 统计符合条件的日志数量

**关键接口**：
- `POST /audit-logs/query` - 查询审计日志，支持按用户名、操作类型、状态、时间范围等条件筛选
- `GET /audit-logs/operation-types` - 获取所有操作类型列表

**记录的操作类型**：
- `LOGIN` - 用户登录
- `LOGOUT` - 用户登出
- `REGISTER` - 用户注册
- `PASSWORD_CHANGE` - 修改密码
- `PASSWORD_RESET` - 重置密码（通过邮箱/手机号）
- `USER_UPDATE` - 更新用户信息
- `USER_DELETE` - 删除用户
- `USER_ADD` - 添加用户
- `ROLE_ASSIGN` - 分配角色
- `ROLE_REVOKE` - 撤销角色

**日志信息**：
- 用户ID和用户名
- 操作类型和描述
- IP地址和User-Agent
- 操作状态（成功/失败）
- 错误信息（失败时）
- 请求方法和路径
- 操作时间

### 5.2 DTO类设计

#### 5.2.1 认证相关DTO

- `LoginRequest` - 登录请求DTO，包含用户名、密码、验证码key和验证码字段
- `RegisterRequest` - 注册请求DTO，包含用户名、密码、邮箱、手机号等字段
- `SmsCodeRequest` - 发送短信验证码请求DTO，包含手机号字段及格式验证
- `SendEmailCodeRequest` - 发送邮箱验证码请求DTO，包含邮箱字段及格式验证
- `PhoneLoginRequest` - 手机验证码登录请求DTO，包含手机号和验证码字段
- `ForgotPasswordRequest` - 密码找回请求DTO，包含找回方式（email/phone）和账号字段
- `ResetPasswordRequest` - 重置密码请求DTO，包含找回方式、账号、验证码和新密码字段
- `WechatQrcodeResponse` - 微信二维码响应DTO，包含二维码URL、ticket和过期时间
- `WechatStatusResponse` - 微信扫码状态响应DTO，包含状态信息和认证响应（确认后返回）

#### 5.2.2 审计日志相关DTO

- `AuditLogQueryRequest` - 审计日志查询请求DTO，包含用户名、操作类型、状态、时间范围、分页参数等字段

### 5.3 工具类

#### 5.3.1 JwtUtils

**主要功能**：JWT令牌的生成、解析和验证。

#### 5.3.2 PasswordUtils

**主要功能**：密码的加密和验证。

#### 5.3.3 RedisUtils

**主要功能**：Redis操作工具类，用于缓存管理、分布式锁等。

#### 5.3.4 HttpRequestUtils

**主要功能**：HTTP请求工具类，用于获取客户端IP地址、User-Agent、请求方法和路径等信息。

**核心方法**：
- `getClientIp()` - 获取客户端IP地址（支持代理场景）
- `getUserAgent()` - 获取User-Agent信息
- `getRequestMethod()` - 获取HTTP请求方法
- `getRequestPath()` - 获取请求路径

### 5.4 Mock数据管理

#### 5.4.1 MockData实体类

**主要功能**：Mock挡板数据的实体映射，支持存储短信验证码和微信登录二维码数据。

**关键字段**：
- `dataType` - 数据类型标识（sms_code/email_code/wechat_qrcode）
- `dataKey` - 数据键（手机号或ticket）
- `dataValue` - 数据值（验证码或二维码URL）
- `extraData` - JSON格式的额外数据（微信状态信息）
- `status` - 状态（active/expired/used）
- `expireTime` - 过期时间

#### 5.4.2 MockDataMapper

**主要功能**：Mock数据的数据库操作接口，支持按类型和键查询、状态更新、过期数据清理等功能。

## 6. 前端功能设计

### 6.1 核心页面

#### 6.1.1 登录页面 (LoginPage.js)

**主要功能**：支持多种登录方式的用户登录页面，包括账号密码登录、手机验证码登录和微信扫码登录。

**核心功能点**：
- **三种登录方式切换**：使用Ant Design Tabs组件实现账号密码、手机验证码、微信扫码三种登录方式的切换
- **账号密码登录**：
  - 登录表单验证
  - 自动填充默认测试账号
  - 记住我功能
  - 图形验证码功能（登录失败达到阈值后显示）
  - 忘记密码链接（跳转到密码找回页面）
- **手机验证码登录**：
  - 手机号格式验证（11位，1开头）
  - 发送验证码按钮，支持60秒倒计时
  - 验证码输入框（6位数字）
  - 验证码验证后登录
- **微信扫码登录**：
  - 自动获取二维码（切换到微信登录标签时）
  - 二维码展示（200x200px）
  - 状态轮询（每秒检查扫码状态，最多2分钟）
  - 状态提示：等待扫码、已扫描（等待确认）、已过期、登录成功
  - 二维码过期后支持刷新
- **通用功能**：
  - 登录状态管理
  - Token存储
  - 错误处理和提示
  - 自动登录功能（页面刷新时）

#### 6.1.2 主页面 (MainPage.js)

**主要功能**：系统主界面，包含侧边栏菜单、顶部导航、内容区域。

**核心功能点**：
- 动态菜单加载
- 菜单树构建
- 页面路由切换
- 用户信息展示

#### 6.1.3 用户管理页面 (UsersListPage.js)

**主要功能**：用户列表展示、用户管理操作，包括添加、编辑、删除用户，配置用户角色，以及设置用户密码。

**核心功能点**：
- 用户列表展示与搜索过滤
- 用户信息编辑与保存
- 用户角色配置
- 用户密码设置功能
  - 密码设置弹窗，支持新密码输入
  - 密码长度验证（至少6个字符）
  - 两次密码输入一致性校验
  - 密码更新结果反馈
- 用户删除确认与操作

#### 6.1.4 角色管理页面 (RolesListPage.js)

**主要功能**：角色列表展示、角色权限配置。

#### 6.1.5 菜单管理页面 (MenusListPage.js)

**主要功能**：菜单树展示、菜单增删改查。

#### 6.1.6 密码找回页面 (ForgotPasswordPage.js)

**主要功能**：用户忘记密码时通过邮箱或手机号重置密码。

**核心功能点**：
- **两种找回方式切换**：使用Ant Design Tabs组件实现邮箱找回和手机号找回两种方式的切换
- **邮箱找回**：
  - 邮箱格式验证
  - 发送验证码功能，支持60秒倒计时
  - 验证码输入和验证
  - 新密码输入和确认密码校验
  - 密码长度验证（至少6位）
- **手机号找回**：
  - 手机号格式验证（11位，1开头）
  - 发送短信验证码功能，支持60秒倒计时
  - 验证码输入和验证
  - 新密码输入和确认密码校验
  - 密码长度验证（至少6位）
- **通用功能**：
  - 密码重置成功后跳转到登录页
  - 错误处理和提示
  - 暗黑模式支持

#### 6.1.7 审计日志页面 (AuditLogPage.js)

**主要功能**：查看系统审计日志，支持多条件筛选和分页查询。

**核心功能点**：
- **搜索筛选**：
  - 按用户名模糊查询
  - 按操作类型筛选（登录、登出、注册、密码修改、密码重置等）
  - 按状态筛选（成功/失败）
  - 按时间范围筛选（支持选择开始和结束时间）
- **日志展示**：
  - 表格形式展示日志列表
  - 显示操作ID、用户名、操作类型、操作描述、状态、IP地址、请求方法、请求路径、错误信息、操作时间等字段
  - 操作类型和状态的中文显示
  - 支持表格横向滚动（适配多列显示）
- **分页功能**：
  - 支持自定义每页数量（10/20/50/100条）
  - 显示总记录数
  - 支持页码跳转
- **其他功能**：
  - 刷新功能
  - 暗黑模式支持
  - 操作按钮（查询、重置、刷新）

### 6.2 全局配置

#### 6.2.1 Axios配置 (App.js)

**主要功能**：配置HTTP请求拦截器，处理Token添加、响应错误处理等。

**核心配置**：
- 基础URL设置
- 请求拦截器：添加Authorization头
- 响应拦截器：处理Token过期、统一错误处理

#### 6.2.2 路由配置

**主要功能**：定义系统路由结构，实现页面导航。

**路由列表**：
- `/login` - 登录页
- `/register` - 注册页
- `/forgot-password` - 密码找回页
- `/` - 主页 (默认重定向到dashboard)
- 其他业务路由 (动态加载，包括审计日志页面audit-logs)

## 7. 安全设计

### 7.1 认证安全

- JWT令牌认证，支持访问令牌和刷新令牌
- Token过期机制，自动刷新Token
- 登录失败次数限制，超过阈值自动锁定用户
- Token黑名单机制，登出后立即失效
- **图形验证码安全**：
  - 登录失败次数达到阈值（默认2次）后要求输入验证码
  - 验证码存储在Redis中，有效期5分钟
  - 验证码验证后立即删除，防止重复使用
  - 使用Kaptcha库生成包含字母和数字的图片验证码
- **手机验证码安全**：
  - 验证码6位随机数字，有效期5分钟
  - 1分钟内防重复发送，防止验证码轰炸
  - 验证码验证后立即标记为已使用，防止重复使用
  - 验证码存储在数据库中，支持过期自动清理
- **邮箱验证码安全**（密码找回）：
  - 验证码6位随机数字，有效期5分钟
  - 1分钟内防重复发送，防止验证码轰炸
  - 验证码验证后立即标记为已使用，防止重复使用
  - 验证码存储在数据库中，支持过期自动清理
  - 密码重置需要验证邮箱或手机号的所有权
- **微信扫码登录安全**：
  - 二维码唯一ticket机制，防止重放攻击
  - 二维码有效期2分钟，过期后自动失效
  - 状态轮询机制，实时更新扫码状态
  - 支持模拟扫码流程（演示环境）

### 7.2 数据安全

- 密码加密存储 (bcrypt)
- 敏感信息传输加密 (HTTPS)
- SQL注入防护 (MyBatis-Plus参数化查询)

### 7.3 审计与监控

- **审计日志记录**：
  - 记录所有关键操作（登录、登出、注册、密码修改、密码重置等）
  - 记录操作上下文信息（用户信息、IP地址、User-Agent、请求路径等）
  - 区分成功和失败操作，失败时记录错误信息
  - 使用独立事务记录日志，确保日志记录失败不影响主业务
- **日志查询与分析**：
  - 支持多条件组合查询（用户名、操作类型、状态、时间范围）
  - 支持分页查询，提高查询性能
  - 建立必要索引，优化查询速度

## 8. 部署配置

### 8.1 后端配置 (application.yml)

**主要配置项**：
- 服务器端口
- 数据库连接信息
- Redis配置
- JWT配置 (密钥、过期时间)
- 登录失败限制配置
- 验证码配置：
  - `captcha.expire-time` - 验证码过期时间（秒），默认300秒（5分钟）
  - `captcha.require-threshold` - 需要验证码的失败次数阈值，默认2次

### 8.2 前端配置 (package.json)

**主要配置项**：
- 依赖管理
- 开发服务器配置
- 代理配置

## 9. 新增功能说明

### 9.1 手机验证码登录功能

**功能概述**：用户可以通过手机号接收验证码的方式进行登录，无需记忆密码。

**技术实现**：
- 后端生成6位随机验证码，保存到`mock_data`表
- 验证码有效期5分钟，1分钟内防重复发送
- 前端实现60秒倒计时，防止频繁请求
- 验证码验证成功后立即标记为已使用

**接口说明**：
- `POST /auth/send-sms-code` - 发送验证码，需要手机号参数
- `POST /auth/login-by-phone` - 手机验证码登录，需要手机号和验证码参数

**安全机制**：
- 手机号格式验证（11位，1开头）
- 验证码有效期控制
- 防重复使用机制
- 发送频率限制

### 9.2 微信扫码登录功能

**功能概述**：用户可以通过微信扫码的方式进行登录，提升用户体验。

**技术实现**：
- 后端生成唯一ticket和二维码URL，保存到`mock_data`表
- 二维码有效期2分钟
- 前端实现状态轮询，每秒检查扫码状态
- 支持模拟扫码流程（演示环境）：15秒后显示"已扫描"，30秒后自动确认登录

**接口说明**：
- `GET /auth/wechat/qrcode` - 获取微信登录二维码，返回二维码URL和ticket
- `GET /auth/wechat/status?ticket=xxx` - 查询微信扫码状态，返回状态信息和认证响应（确认后）

**状态流转**：
- `waiting` - 等待扫码
- `scanned` - 已扫描，等待用户确认
- `confirmed` - 已确认，返回认证Token
- `expired` - 二维码已过期

**前端实现**：
- 自动获取二维码（切换到微信登录标签时）
- 状态轮询机制（每秒检查，最多120次）
- 状态提示和UI反馈
- 过期后支持刷新二维码

### 9.3 图形验证码功能

**功能概述**：在用户登录失败次数达到阈值后，要求用户输入图形验证码，防止暴力破解攻击。

**技术实现**：
- 使用Kaptcha库生成包含字母和数字的图片验证码
- 验证码存储在Redis中，有效期5分钟
- 登录失败次数达到阈值（默认2次）后自动显示验证码输入框
- 验证码验证后立即从Redis删除，防止重复使用
- 前端自动获取验证码图片（Base64格式）并显示
- 支持点击验证码图片刷新

**接口说明**：
- `GET /captcha/image` - 获取验证码图片，返回Base64编码的图片和验证码key
- `GET /captcha/required?username=xxx` - 检查指定用户名是否需要验证码

**配置参数**：
- `captcha.expire-time` - 验证码过期时间（秒），默认300秒（5分钟）
- `captcha.require-threshold` - 需要验证码的失败次数阈值，默认2次

### 9.4 密码找回功能

**功能概述**：用户忘记密码时，可以通过邮箱或手机号接收验证码的方式重置密码。

**技术实现**：
- 支持两种找回方式：邮箱验证码和手机号短信验证码
- 后端生成6位随机验证码，保存到`mock_data`表
- 验证码有效期5分钟，1分钟内防重复发送
- 前端实现60秒倒计时，防止频繁请求
- 验证码验证成功后立即标记为已使用
- 密码重置需要输入新密码和确认密码，进行一致性校验

**接口说明**：
- `POST /auth/send-email-code` - 发送邮箱验证码，需要邮箱参数
- `POST /auth/reset-password` - 重置密码，支持邮箱和手机号两种方式，需要账号、验证码和新密码参数

**安全机制**：
- 邮箱格式验证（标准邮箱格式）
- 手机号格式验证（11位，1开头）
- 验证码有效期控制
- 防重复使用机制
- 发送频率限制（1分钟内防重复发送）
- 密码重置需要验证邮箱或手机号的所有权

### 9.5 暗黑模式功能

**功能概述**：系统支持浅色和暗黑两种主题模式，用户可以根据个人喜好或环境光线切换主题。

**技术实现**：
- 使用React Context实现主题状态管理
- 主题设置持久化到localStorage
- 使用CSS变量定义主题颜色
- 全面覆盖Ant Design组件和自定义组件的暗黑模式样式
- 支持登录页、注册页、主页面、所有管理页面的暗黑模式

**核心功能点**：
- 主题切换按钮（灯泡图标）
- 主题状态持久化
- 完整的暗黑模式样式适配（表格、菜单、表单、按钮、标签等）
- 确保所有文本、边框、背景在暗黑模式下清晰可见

### 9.6 审计日志功能

**功能概述**：记录系统关键操作的审计日志，支持多条件查询和统计分析，用于安全审计和问题排查。

**技术实现**：
- 创建独立的审计日志表（`audit_logs`）
- 使用独立事务记录日志，确保日志记录失败不影响主业务
- 集成到关键操作中：登录、登出、注册、密码修改、密码重置等
- 记录操作上下文信息：用户信息、IP地址、User-Agent、请求方法和路径
- 区分操作成功和失败状态，失败时记录错误信息
- 支持多条件组合查询（用户名、操作类型、状态、时间范围）
- 支持分页查询，建立必要索引优化查询性能

**接口说明**：
- `POST /audit-logs/query` - 查询审计日志，支持多条件筛选和分页
- `GET /audit-logs/operation-types` - 获取所有操作类型列表

**记录的操作类型**：
- `LOGIN` - 用户登录（成功/失败）
- `LOGOUT` - 用户登出
- `REGISTER` - 用户注册（成功/失败）
- `PASSWORD_CHANGE` - 修改密码
- `PASSWORD_RESET` - 重置密码（通过邮箱/手机号）
- `USER_UPDATE` - 更新用户信息
- `USER_DELETE` - 删除用户
- `USER_ADD` - 添加用户
- `ROLE_ASSIGN` - 分配角色
- `ROLE_REVOKE` - 撤销角色

**前端功能**：
- 审计日志查看页面（`AuditLogPage.js`）
- 支持按用户名、操作类型、状态、时间范围筛选
- 表格展示日志详情
- 分页查询和刷新功能
- 暗黑模式支持

### 9.7 Mock挡板数据管理

**设计目的**：在开发和测试环境中，使用Mock数据表存储验证码和二维码信息，避免依赖第三方服务（短信服务、微信开放平台）。

**表结构设计**：
- `data_type` - 数据类型标识（sms_code/email_code/wechat_qrcode）
- `data_key` - 数据键（手机号、邮箱或ticket）
- `data_value` - 数据值（验证码或二维码URL）
- `extra_data` - JSON格式的额外数据（用于存储微信状态信息）
- `status` - 状态管理（active/expired/used）
- `expire_time` - 过期时间控制

**数据清理**：
- 支持按过期时间自动清理过期数据
- 验证码使用后立即标记为已使用
- 二维码过期后标记为过期状态

## 10. 总结

本系统是一个基于Spring Boot和React的前后端分离登录演示系统，实现了完整的用户认证、权限管理、菜单管理功能。系统采用JWT无状态认证，支持用户角色权限控制，菜单树动态生成等特性。通过MySQL存储业务数据，Redis缓存临时数据，保证了系统的性能和安全性。

**最新更新**：
1. **图形验证码防护**：系统新增了图形验证码功能，登录失败次数达到阈值后要求输入验证码，有效防止暴力破解攻击。验证码使用Kaptcha库生成，存储在Redis中，验证后立即删除。
2. **密码找回功能**：用户可以通过邮箱或手机号接收验证码的方式重置密码，支持两种找回方式切换，验证码有效期5分钟，1分钟内防重复发送。
3. **暗黑模式**：系统全面支持暗黑模式，使用React Context管理主题状态，持久化到localStorage，完整适配所有页面和组件的暗黑模式样式。
4. **审计日志系统**：新增完整的审计日志功能，记录所有关键操作（登录、登出、注册、密码修改、密码重置等），包含操作上下文信息（用户信息、IP地址、User-Agent等），支持多条件查询和统计分析。
5. **Mock数据扩展**：扩展了Mock挡板数据表，支持存储邮箱验证码，统一管理短信验证码、邮箱验证码和微信登录二维码数据。

系统架构清晰，模块划分合理，代码结构规范，便于维护和扩展。详细设计文档覆盖了数据库设计、前端页面、后端功能和技术栈使用情况，包括所有新增功能，可以作为系统开发和维护的重要参考。